<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Transfer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #fileInput {
      margin: 10px 0;
    }
    textarea {
      width: 80%;
      height: 100px;
      margin: 10px 0;
    }
    button {
      padding: 10px 15px;
      margin: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer File Transfer</h1>
  <p>Share files directly between devices using WebRTC.</p>

  <h2>Step 1: Sender</h2>
  <input type="file" id="fileInput" />
  <button id="sendFileButton">Send File</button>

  <h2>Step 2: Share Signaling Data</h2>
  <p>Copy and share the connection offer/answer:</p>
  <textarea id="offerBox" placeholder="Offer/Answer will appear here"></textarea>
  <button id="copyOffer">Copy Offer</button>
  <button id="setAnswer">Set Answer</button>

  <textarea id="answerBox" placeholder="Paste the answer here"></textarea>
  <button id="setOffer">Set Offer</button>
  <button id="startConnection">Start Connection</button>

  <h2>Received Files</h2>
  <a id="downloadLink" style="display: none;">Download Received File</a>
  <p id="status"></p>

  <script>
    let peerConnection;
    let dataChannel;
    let fileReader;
    let receivedBuffer = [];
    let receivedSize = 0;
    let fileSize = 0;

    // Create WebRTC peer connection
    function createPeerConnection() {
      peerConnection = new RTCPeerConnection();
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log("New ICE Candidate:", event.candidate);
        }
      };

      peerConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel();
      };
    }

    // Setup the data channel
    function setupDataChannel() {
      dataChannel.onopen = () => {
        console.log("Data channel is open");
        document.getElementById('status').textContent = "Connection established!";
      };
      dataChannel.onmessage = (event) => {
        const { data } = event;
        if (data instanceof ArrayBuffer) {
          receivedBuffer.push(data);
          receivedSize += data.byteLength;
          if (receivedSize === fileSize) {
            const receivedFile = new Blob(receivedBuffer);
            const downloadLink = document.getElementById("downloadLink");
            downloadLink.href = URL.createObjectURL(receivedFile);
            downloadLink.download = "received_file";
            downloadLink.style.display = "block";
          }
        } else if (typeof data === "string") {
          fileSize = parseInt(data);
          console.log(`Expecting file size: ${fileSize}`);
        }
      };
    }

    // Set up offer/answer for signaling
    document.getElementById("setOffer").onclick = async () => {
      const offer = document.getElementById("answerBox").value;
      if (offer) {
        await peerConnection.setRemoteDescription(JSON.parse(offer));
      }
    };

    document.getElementById("setAnswer").onclick = async () => {
      const answer = document.getElementById("answerBox").value;
      if (answer) {
        await peerConnection.setRemoteDescription(JSON.parse(answer));
      }
    };

    document.getElementById("copyOffer").onclick = () => {
      const offerBox = document.getElementById("offerBox");
      offerBox.select();
      document.execCommand("copy");
    };

    document.getElementById("startConnection").onclick = async () => {
      if (!peerConnection) createPeerConnection();

      dataChannel = peerConnection.createDataChannel("fileTransfer");
      setupDataChannel();

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      document.getElementById("offerBox").value = JSON.stringify(peerConnection.localDescription);
    };

    document.getElementById("sendFileButton").onclick = () => {
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length > 0 && dataChannel) {
        const file = fileInput.files[0];
        fileReader = new FileReader();
        fileReader.onload = (e) => {
          const chunk = e.target.result;
          dataChannel.send(chunk);
        };

        dataChannel.send(file.size.toString()); // Send file size first
        fileReader.readAsArrayBuffer(file);
      }
    };
  </script>
</body>
</html>
