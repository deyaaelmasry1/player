<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Transfer with Fixed Peer Code</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #fileInput {
      margin: 10px 0;
    }
    button {
      padding: 10px 15px;
      margin: 10px;
      cursor: pointer;
    }
    #peerCodeBox {
      margin: 10px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer File Transfer</h1>
  <p>Use a fixed Peer Code to connect directly with another device.</p>

  <h2>Step 1: Your Fixed Peer Code</h2>
  <div id="peerCodeBox"></div>
  <p>Share this code with your peer to connect.</p>

  <h2>Step 2: Enter Peer Code</h2>
  <input type="text" id="peerCodeInput" placeholder="Enter peer code here" />
  <button id="connectPeerButton">Connect</button>

  <h2>Step 3: Send File</h2>
  <input type="file" id="fileInput" />
  <button id="sendFileButton">Send File</button>

  <h2>Received Files</h2>
  <a id="downloadLink" style="display: none;">Download Received File</a>
  <p id="status"></p>

  <script>
    let peerConnection;
    let dataChannel;
    let fileReader;
    let receivedBuffer = [];
    let receivedSize = 0;
    let fileSize = 0;
    let peerCode = "peer123"; // Fixed Peer Code for this peer

    // Set a cookie with the given name and value
    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }

    // Get the value of a cookie by name
    function getCookie(name) {
      const nameEq = name + "=";
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let c = cookies[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEq) === 0) return c.substring(nameEq.length, c.length);
      }
      return null;
    }

    // Set the fixed peer code in the cookie
    function saveFixedPeerCode() {
      setCookie('peerCode', peerCode, 365); // Save for 1 year
      document.getElementById('peerCodeBox').textContent = `Your Peer Code: ${peerCode}`;
    }

    // Load the fixed peer code from the cookie
    function loadFixedPeerCode() {
      const savedPeerCode = getCookie('peerCode');
      if (savedPeerCode) {
        peerCode = savedPeerCode;
        document.getElementById('peerCodeBox').textContent = `Your Peer Code: ${peerCode}`;
      } else {
        saveFixedPeerCode(); // Set the code if not found in cookies
      }
    }

    // Set up WebRTC peer connection
    function createPeerConnection() {
      peerConnection = new RTCPeerConnection();
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log("New ICE Candidate:", event.candidate);
        }
      };

      peerConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel();
      };
    }

    // Setup the data channel for sending/receiving data
    function setupDataChannel() {
      dataChannel.onopen = () => {
        document.getElementById('status').textContent = "Connection established!";
      };
      dataChannel.onmessage = (event) => {
        const { data } = event;
        if (data instanceof ArrayBuffer) {
          receivedBuffer.push(data);
          receivedSize += data.byteLength;
          if (receivedSize === fileSize) {
            const receivedFile = new Blob(receivedBuffer);
            const downloadLink = document.getElementById("downloadLink");
            downloadLink.href = URL.createObjectURL(receivedFile);
            downloadLink.download = "received_file";
            downloadLink.style.display = "block";
          }
        } else if (typeof data === "string") {
          fileSize = parseInt(data);
        }
      };
    }

    // Connect to a peer using the provided peer code
    function connectToPeer(code) {
      if (!peerConnection) createPeerConnection();

      dataChannel = peerConnection.createDataChannel("fileTransfer");
      setupDataChannel();

      // Check if the entered peer code matches the fixed peer code
      if (peerCode === code) {
        peerConnection.createOffer()
          .then(offer => {
            return peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            console.log("Offer sent, waiting for answer...");
            document.getElementById('status').textContent = "Offer sent, waiting for peer response...";
          });
      } else {
        document.getElementById('status').textContent = "Invalid Peer Code!";
      }
    }

    // Connect to the peer using the code entered
    document.getElementById("connectPeerButton").onclick = () => {
      const enteredCode = document.getElementById("peerCodeInput").value;
      if (enteredCode) {
        connectToPeer(enteredCode);
      }
    };

    // Send the file via the established data channel
    document.getElementById("sendFileButton").onclick = () => {
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length > 0 && dataChannel) {
        const file = fileInput.files[0];
        fileReader = new FileReader();
        fileReader.onload = (e) => {
          const chunk = e.target.result;
          dataChannel.send(chunk);
        };

        dataChannel.send(file.size.toString()); // Send file size first
        fileReader.readAsArrayBuffer(file);
      }
    };

    // Load the saved peer code from the cookie when the page loads
    loadFixedPeerCode();
  </script>
</body>
</html>
