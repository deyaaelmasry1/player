<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Transfer with Persistent Peer Code</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #fileInput {
      margin: 10px 0;
    }
    textarea {
      width: 80%;
      height: 100px;
      margin: 10px 0;
    }
    button {
      padding: 10px 15px;
      margin: 10px;
      cursor: pointer;
    }
    #peerCodeBox {
      margin: 10px;
      font-size: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer File Transfer</h1>
  <p>Use a unique Peer Code to connect directly with another device.</p>

  <h2>Step 1: Create a Peer Code</h2>
  <button id="generatePeerCode">Generate Peer Code</button>
  <div id="peerCodeBox"></div>
  <p>Share this code with your peer to connect.</p>

  <h2>Step 2: Enter Peer Code</h2>
  <input type="text" id="peerCodeInput" placeholder="Enter peer code here" />
  <button id="connectPeerButton">Connect</button>

  <h2>Step 3: Send File</h2>
  <input type="file" id="fileInput" />
  <button id="sendFileButton">Send File</button>

  <h2>Received Files</h2>
  <a id="downloadLink" style="display: none;">Download Received File</a>
  <p id="status"></p>

  <script>
    let peerConnection;
    let dataChannel;
    let fileReader;
    let receivedBuffer = [];
    let receivedSize = 0;
    let fileSize = 0;
    let peerCode;

    // Set a cookie with the given name and value
    function setCookie(name, value, days) {
      const expires = new Date();
      expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
    }

    // Get the value of a cookie by name
    function getCookie(name) {
      const nameEq = name + "=";
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        let c = cookies[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEq) === 0) return c.substring(nameEq.length, c.length);
      }
      return null;
    }

    // Generate a random peer code and save it in a cookie
    function generatePeerCode() {
      peerCode = Math.random().toString(36).substring(2, 10);
      setCookie('peerCode', peerCode, 365); // Save for 1 year
      document.getElementById('peerCodeBox').textContent = `Your Peer Code: ${peerCode}`;
    }

    // Set the peer code from the cookie if available
    function loadPeerCodeFromCookie() {
      const savedPeerCode = getCookie('peerCode');
      if (savedPeerCode) {
        peerCode = savedPeerCode;
        document.getElementById('peerCodeBox').textContent = `Your Peer Code: ${peerCode}`;
      }
    }

    // Set up WebRTC peer connection
    function createPeerConnection() {
      peerConnection = new RTCPeerConnection();
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          console.log("New ICE Candidate:", event.candidate);
        }
      };

      peerConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        setupDataChannel();
      };
    }

    // Setup the data channel for sending/receiving data
    function setupDataChannel() {
      dataChannel.onopen = () => {
        document.getElementById('status').textContent = "Connection established!";
      };
      dataChannel.onmessage = (event) => {
        const { data } = event;
        if (data instanceof ArrayBuffer) {
          receivedBuffer.push(data);
          receivedSize += data.byteLength;
          if (receivedSize === fileSize) {
            const receivedFile = new Blob(receivedBuffer);
            const downloadLink = document.getElementById("downloadLink");
            downloadLink.href = URL.createObjectURL(receivedFile);
            downloadLink.download = "received_file";
            downloadLink.style.display = "block";
          }
        } else if (typeof data === "string") {
          fileSize = parseInt(data);
        }
      };
    }

    // Connect to a peer using the provided peer code
    function connectToPeer(code) {
      if (!peerConnection) createPeerConnection();

      dataChannel = peerConnection.createDataChannel("fileTransfer");
      setupDataChannel();

      // Simulate the peer's response based on the code (In a real system, this should be done with signaling)
      if (peerCode === code) {
        peerConnection.createOffer()
          .then(offer => {
            return peerConnection.setLocalDescription(offer);
          })
          .then(() => {
            console.log("Offer sent, waiting for answer...");
            document.getElementById('status').textContent = "Offer sent, waiting for peer response...";
          });
      } else {
        document.getElementById('status').textContent = "Invalid Peer Code!";
      }
    }

    // Generate Peer Code for the user
    document.getElementById("generatePeerCode").onclick = () => {
      generatePeerCode();
    };

    // Connect to the peer using the code entered
    document.getElementById("connectPeerButton").onclick = () => {
      const enteredCode = document.getElementById("peerCodeInput").value;
      if (enteredCode) {
        connectToPeer(enteredCode);
      }
    };

    // Send the file via the established data channel
    document.getElementById("sendFileButton").onclick = () => {
      const fileInput = document.getElementById("fileInput");
      if (fileInput.files.length > 0 && dataChannel) {
        const file = fileInput.files[0];
        fileReader = new FileReader();
        fileReader.onload = (e) => {
          const chunk = e.target.result;
          dataChannel.send(chunk);
        };

        dataChannel.send(file.size.toString()); // Send file size first
        fileReader.readAsArrayBuffer(file);
      }
    };

    // Load the saved peer code from the cookie when the page loads
    loadPeerCodeFromCookie();
  </script>
</body>
</html>
