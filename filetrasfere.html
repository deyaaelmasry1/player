<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer File Transfer with PeerJS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input, button {
            padding: 10px;
            margin: 10px;
        }
        #peerCodeDisplay {
            font-size: 20px;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h2>Peer-to-Peer File Transfer with PeerJS</h2>

    <div>
        <label for="peerId">Enter 4-digit Peer Code: </label>
        <input type="text" id="peerId" maxlength="4">
        <button id="connectButton">Connect</button>
        <button id="generateCodeButton">Generate Code</button>
    </div>

    <div id="peerCodeDisplay"></div>

    <h3>Send a file:</h3>
    <input type="file" id="fileInput">
    <button id="sendFileButton" disabled>Send File</button>

    <h3>Receive File:</h3>
    <button id="receiveFileButton" disabled>Receive File</button>
    <div id="receivedFileName"></div>

    <script src="https://cdn.peerjs.com/peerjs/1.3.1/peerjs.min.js"></script>

    <script>
        const connectButton = document.getElementById('connectButton');
        const peerIdInput = document.getElementById('peerId');
        const sendFileButton = document.getElementById('sendFileButton');
        const fileInput = document.getElementById('fileInput');
        const receiveFileButton = document.getElementById('receiveFileButton');
        const receivedFileName = document.getElementById('receivedFileName');
        const peerCodeDisplay = document.getElementById('peerCodeDisplay');
        const generateCodeButton = document.getElementById('generateCodeButton');

        let peer;
        let conn;
        let fileData = null;
        let fileBlob = null;

        // Initialize PeerJS
        function initPeer() {
            // Create a Peer with a random ID, or use a custom one if provided
            peer = new Peer(undefined, {
                host: 'peerjs.com', // Use the default PeerJS server
                secure: true,
                port: 443
            });

            // Get the generated peer ID
            peer.on('open', (id) => {
                peerCodeDisplay.textContent = `Your peer code: ${id}`;
                peerIdInput.value = id;
                setCookie('peerCode', id, 7); // Save the peer code in a cookie
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
            });

            peer.on('error', (err) => {
                alert('Error: ' + err);
            });
        }

        // Set up the connection once a peer is connected
        function setupConnection() {
            conn.on('data', (data) => {
                if (data instanceof ArrayBuffer) {
                    const receivedBlob = new Blob([data]);
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(receivedBlob);
                    link.download = 'receivedFile';
                    link.click();
                    alert("File received!");
                }
            });

            conn.on('open', () => {
                sendFileButton.disabled = false;
                receiveFileButton.disabled = false;
                console.log("Connection established.");
            });
        }

        // Connect to another peer by peer ID
        connectButton.onclick = () => {
            const peerId = peerIdInput.value;
            if (peerId.length === 4) {
                conn = peer.connect(peerId);
                setupConnection();
            } else {
                alert("Please enter a valid 4-digit peer code.");
            }
        };

        // Generate a unique 4-digit peer code
        generateCodeButton.onclick = () => {
            const peerCode = Math.floor(1000 + Math.random() * 9000); // Generate a 4-digit code
            peerIdInput.value = peerCode;
            setCookie('peerCode', peerCode, 7); // Save the peer code in a cookie
            peerCodeDisplay.textContent = `Your peer code: ${peerCode}`;
        };

        // Initialize from cookie if available
        window.onload = () => {
            const savedPeerCode = getCookie('peerCode');
            if (savedPeerCode) {
                peerCodeDisplay.textContent = `Your peer code: ${savedPeerCode}`;
                peerIdInput.value = savedPeerCode;
            }
        };

        // Send file
        sendFileButton.onclick = () => {
            const file = fileInput.files[0];
            if (file) {
                const fileReader = new FileReader();
                fileReader.onload = () => {
                    const fileData = fileReader.result;
                    conn.send(fileData);
                    alert("File sent!");
                };
                fileReader.readAsArrayBuffer(file);
            }
        };

        // Receive file
        receiveFileButton.onclick = () => {
            // Trigger file download from received data
            const blob = new Blob([fileData]);
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "received_file";
            link.click();
        };

        // Cookie functions for saving peer code
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = `expires=${d.toUTCString()}`;
            document.cookie = `${name}=${value}; ${expires}; path=/`;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Initialize peer connection on page load
        initPeer();
    </script>
</body>
</html>
