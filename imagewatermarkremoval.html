<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watermark Removal with User Selection</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    #image-input {
      margin-bottom: 20px;
    }
    .controls {
      margin-top: 10px;
    }
    .controls button {
      margin-right: 10px;
    }
    #original-container, #modified-container {
      display: inline-block;
      width: 48%;
      vertical-align: top;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    .selection-box {
      border: 2px dashed #ff0000;
      position: absolute;
      pointer-events: none;
    }
  </style>
</head>
<body>

<h1>Watermark Removal with User Selection</h1>
<p>Upload an image, select the watermark region, and remove it.</p>

<input type="file" id="image-input" accept="image/*">
<div id="image-info"></div>

<!-- Containers for Original and Modified Image -->
<div id="original-container">
  <h3>Original Image</h3>
  <canvas id="original-canvas" width="400" height="300"></canvas>
</div>
<div id="modified-container">
  <h3>Modified Image</h3>
  <canvas id="modified-canvas" width="400" height="300"></canvas>
</div>

<div class="controls">
  <button id="remove-selected">Remove Selected Area</button>
</div>

<script>
  let imageElement, originalImageData, ctxOriginal, ctxModified;
  let selectionBox = null;
  let selectionStartX = 0, selectionStartY = 0;
  let selectionWidth = 0, selectionHeight = 0;

  document.getElementById('image-input').addEventListener('change', handleImageUpload);

  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          imageElement = img;
          document.getElementById('image-info').innerHTML = 'Image loaded. Please select the watermark area to remove.';

          // Display the original image
          const originalCanvas = document.getElementById('original-canvas');
          ctxOriginal = originalCanvas.getContext('2d');
          ctxOriginal.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
          ctxOriginal.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);

          // Store original image data for reference
          originalImageData = ctxOriginal.getImageData(0, 0, originalCanvas.width, originalCanvas.height);

          // Initialize modified canvas
          const modifiedCanvas = document.getElementById('modified-canvas');
          ctxModified = modifiedCanvas.getContext('2d');
          ctxModified.clearRect(0, 0, modifiedCanvas.width, modifiedCanvas.height);
          ctxModified.drawImage(img, 0, 0, modifiedCanvas.width, modifiedCanvas.height);

          // Allow selection of the region for removal
          enableRegionSelection(originalCanvas);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  // Enable region selection on the canvas
  function enableRegionSelection(canvas) {
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
  }

  // Start selection when the mouse is pressed
  function onMouseDown(event) {
    selectionStartX = event.offsetX;
    selectionStartY = event.offsetY;
    selectionWidth = 0;
    selectionHeight = 0;

    if (selectionBox) {
      selectionBox.remove();
    }
    selectionBox = document.createElement('div');
    selectionBox.className = 'selection-box';
    document.body.appendChild(selectionBox);
  }

  // Update selection area while the mouse is moving
  function onMouseMove(event) {
    if (selectionBox) {
      selectionWidth = event.offsetX - selectionStartX;
      selectionHeight = event.offsetY - selectionStartY;

      // Update position and size of the selection box
      selectionBox.style.left = `${selectionStartX}px`;
      selectionBox.style.top = `${selectionStartY}px`;
      selectionBox.style.width = `${Math.abs(selectionWidth)}px`;
      selectionBox.style.height = `${Math.abs(selectionHeight)}px`;
    }
  }

  // Finalize selection and store the region
  function onMouseUp() {
    if (selectionWidth !== 0 && selectionHeight !== 0) {
      alert("Region selected. Click 'Remove Selected Area' to proceed.");
    }
  }

  // Remove the selected area from the image
  document.getElementById('remove-selected').addEventListener('click', () => {
    if (selectionWidth !== 0 && selectionHeight !== 0) {
      removeSelectedArea(selectionStartX, selectionStartY, Math.abs(selectionWidth), Math.abs(selectionHeight));
    } else {
      alert("No area selected to remove.");
    }
  });

  // Remove selected area by filling it with surrounding pixels
  function removeSelectedArea(x, y, width, height) {
    // Get the surrounding pixels to fill in the selected area
    const surroundingPixels = getSurroundingPixels(x, y, width, height);

    // Rebuild the region by replacing with surrounding pixels
    for (let i = 0; i < width; i++) {
      for (let j = 0; j < height; j++) {
        const pixelIndex = ((y + j) * originalImageData.width + (x + i)) * 4;
        originalImageData.data[pixelIndex] = surroundingPixels[i][j].r;
        originalImageData.data[pixelIndex + 1] = surroundingPixels[i][j].g;
        originalImageData.data[pixelIndex + 2] = surroundingPixels[i][j].b;
        originalImageData.data[pixelIndex + 3] = 255; // Fully opaque
      }
    }

    // Redraw the modified image
    ctxModified.putImageData(originalImageData, 0, 0);
  }

  // Get surrounding pixels (simple average approach)
  function getSurroundingPixels(x, y, width, height) {
    let pixels = [];
    for (let i = 0; i < width; i++) {
      pixels[i] = [];
      for (let j = 0; j < height; j++) {
        const px = x + i;
        const py = y + j;
        const pixelIndex = (py * originalImageData.width + px) * 4;
        const r = originalImageData.data[pixelIndex];
        const g = originalImageData.data[pixelIndex + 1];
        const b = originalImageData.data[pixelIndex + 2];

        pixels[i][j] = { r, g, b };
      }
    }
    return pixels;
  }
</script>

</body>
</html>
