<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watermark Detection and Removal with TensorFlow.js</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    #image-input {
      margin-bottom: 20px;
    }
    .controls {
      margin-top: 10px;
    }
    .controls button {
      margin-right: 10px;
    }
    #original-container, #modified-container {
      display: inline-block;
      width: 48%;
      vertical-align: top;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Watermark Detection and Removal</h1>
<p>Upload an image, detect the watermark region using AI, and see the image before and after watermark removal.</p>

<input type="file" id="image-input" accept="image/*">
<div id="image-info"></div>

<!-- Containers for Original and Modified Image -->
<div id="original-container">
  <h3>Original Image</h3>
  <canvas id="original-canvas" width="400" height="300"></canvas>
</div>
<div id="modified-container">
  <h3>Modified Image</h3>
  <canvas id="modified-canvas" width="400" height="300"></canvas>
</div>

<div class="controls">
  <button id="remove-watermark">Remove Watermark</button>
</div>

<script>
  let imageElement, originalImageData, ctxOriginal, ctxModified;
  let detectedRegions = [];

  document.getElementById('image-input').addEventListener('change', handleImageUpload);

  async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = async function() {
          imageElement = img;
          document.getElementById('image-info').innerHTML = 'Image loaded. Detecting watermark...';

          // Display the original image
          const originalCanvas = document.getElementById('original-canvas');
          ctxOriginal = originalCanvas.getContext('2d');
          ctxOriginal.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
          ctxOriginal.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);

          // Store original image data for reference
          originalImageData = ctxOriginal.getImageData(0, 0, originalCanvas.width, originalCanvas.height);

          // Initialize modified canvas
          const modifiedCanvas = document.getElementById('modified-canvas');
          ctxModified = modifiedCanvas.getContext('2d');
          ctxModified.clearRect(0, 0, modifiedCanvas.width, modifiedCanvas.height);
          ctxModified.drawImage(img, 0, 0, modifiedCanvas.width, modifiedCanvas.height);

          // Load the COCO-SSD model
          const model = await cocoSsd.load();
          detectWatermark(model, img);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  // Detect watermark region using the COCO-SSD model
  async function detectWatermark(model, img) {
    const predictions = await model.detect(img);

    // Filter out predictions that are likely to be a watermark (e.g., text-like objects)
    detectedRegions = predictions.filter(prediction => {
      // You can customize this filtering to target specific objects that resemble a watermark
      return prediction.class === 'person' || prediction.class === 'bottle'; // Example filtering
    });

    if (detectedRegions.length > 0) {
      alert("Watermark detected, click 'Remove Watermark' to proceed.");
    } else {
      alert("No watermark detected.");
    }
  }

  // Remove watermark by rebuilding the region (basic approach)
  document.getElementById('remove-watermark').addEventListener('click', () => {
    if (detectedRegions.length > 0) {
      detectedRegions.forEach(region => {
        removeWatermark(region);
      });
      alert("Watermark removed. See the comparison.");
    } else {
      alert("No watermark detected to remove.");
    }
  });

  // Simple removal of the watermark by filling the region with surrounding pixels
  function removeWatermark(region) {
    const { bbox } = region;
    const width = bbox[2];
    const height = bbox[3];
    const x = bbox[0];
    const y = bbox[1];

    // Get the surrounding pixels to fill in the watermark area
    const surroundingPixels = getSurroundingPixels(x, y, width, height);

    // Rebuild the region by replacing with surrounding pixels
    for (let i = 0; i < width; i++) {
      for (let j = 0; j < height; j++) {
        const pixelIndex = ((y + j) * originalImageData.width + (x + i)) * 4;
        originalImageData.data[pixelIndex] = surroundingPixels[i][j].r;
        originalImageData.data[pixelIndex + 1] = surroundingPixels[i][j].g;
        originalImageData.data[pixelIndex + 2] = surroundingPixels[i][j].b;
        originalImageData.data[pixelIndex + 3] = 255; // Fully opaque
      }
    }

    // Redraw the modified image
    ctxModified.putImageData(originalImageData, 0, 0);
  }

  // Get surrounding pixels (basic average approach)
  function getSurroundingPixels(x, y, width, height) {
    let pixels = [];
    for (let i = 0; i < width; i++) {
      pixels[i] = [];
      for (let j = 0; j < height; j++) {
        const px = x + i;
        const py = y + j;
        const pixelIndex = (py * originalImageData.width + px) * 4;
        const r = originalImageData.data[pixelIndex];
        const g = originalImageData.data[pixelIndex + 1];
        const b = originalImageData.data[pixelIndex + 2];

        pixels[i][j] = { r, g, b };
      }
    }
    return pixels;
  }
</script>

</body>
</html>
