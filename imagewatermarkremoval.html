<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Watermark Removal - Before and After</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.2/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.2.0/pixi.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.1/fabric.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f4f4f4;
    }
    #image-input {
      margin-bottom: 20px;
    }
    .controls {
      margin-top: 10px;
    }
    .controls button {
      margin-right: 10px;
    }
    #original-container, #modified-container {
      display: inline-block;
      width: 48%;
      vertical-align: top;
    }
    canvas {
      border: 1px solid #ccc;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h1>Watermark Removal - Before and After</h1>
<p>Upload an image, automatically detect any watermark, remove it, and see the difference between the original and modified image.</p>

<input type="file" id="image-input" accept="image/*">
<div id="image-info"></div>

<!-- Containers for Original and Modified Image -->
<div id="original-container">
  <h3>Original Image</h3>
  <canvas id="original-canvas" width="400" height="300"></canvas>
</div>
<div id="modified-container">
  <h3>Modified Image</h3>
  <canvas id="modified-canvas" width="400" height="300"></canvas>
</div>

<div class="controls">
  <button id="remove-watermark">Remove Watermark</button>
</div>

<script>
  let imageElement, appPixi, detectedTextRegions = [];
  let originalImageData;

  document.getElementById('image-input').addEventListener('change', handleImageUpload);

  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          imageElement = img;
          document.getElementById('image-info').innerHTML = 'Image loaded. Ready to detect watermark.';

          // Display the original image
          const originalCanvas = document.getElementById('original-canvas');
          const ctxOriginal = originalCanvas.getContext('2d');
          ctxOriginal.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
          ctxOriginal.drawImage(img, 0, 0, originalCanvas.width, originalCanvas.height);

          // Initialize PixiJS for watermark removal
          appPixi = new PIXI.Application({
            view: document.getElementById('modified-canvas'),
            width: 400,
            height: 300
          });

          const texture = PIXI.Texture.from(img);
          const sprite = new PIXI.Sprite(texture);
          appPixi.stage.addChild(sprite);

          detectTextAndRemove(img);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  // Detect watermark using Tesseract.js
  function detectTextAndRemove(img) {
    Tesseract.recognize(
      img,
      'eng',
      {
        logger: (m) => console.log(m)
      }
    ).then(({ data: { text, blocks } }) => {
      console.log("Detected Text: ", text);
      if (blocks) {
        detectedTextRegions = blocks.map(block => block.bbox);
        alert("Watermark detected, click 'Remove Watermark' to proceed.");
      } else {
        alert("No text watermark detected.");
      }
    });
  }

  // Remove watermark and show difference
  document.getElementById('remove-watermark').addEventListener('click', () => {
    if (appPixi && imageElement && detectedTextRegions.length > 0) {
      // Recreate PixiJS sprite for modified image
      const texture = PIXI.Texture.from(imageElement);
      const sprite = new PIXI.Sprite(texture);
      appPixi.stage.addChild(sprite);

      // Apply a mask (or blur) to remove detected text
      detectedTextRegions.forEach(region => {
        const rect = new PIXI.Graphics();
        rect.beginFill(0xFFFFFF, 1); // White fill to mask the text
        rect.drawRect(region.x, region.y, region.width, region.height);
        rect.endFill();
        appPixi.stage.addChild(rect);

        // Optionally, you could apply a blur instead of masking (comment out the masking lines and uncomment the blur filter lines)
        // rect.filters = [new PIXI.filters.BlurFilter(5)]; // Adjust blur amount as needed
      });

      appPixi.render();
    } else {
      alert("No watermark detected to remove.");
    }
  });
</script>

</body>
</html>
